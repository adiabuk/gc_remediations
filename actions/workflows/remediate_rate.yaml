version: 1.0
description: remediate trades having a high rate of change

input:
  - down_device
  - service

tasks:
  start:
    action: gc_remediations.get_rate_details service=<% ctx(service) %>
    retry:
        delay: 1
        count: 2
    next:
      - when: <% succeeded() %>
        publish:
          - environment: <% result().result.env %>
          - direction: <% result().result.direction %>
        do:
          - check_rate
          - finish

  check_rate:
    input:
      environment: <% ctx().environment %>
      direction: <% ctx().direction %>
    action: gc_remediations.check_rate
    next:
      - when: <% succeeded() %>
        publish:
          - result_value: <% result().result %>
      - when: <% int(ctx().result_value) > 0 %>
        do:
          - proceed
      #- when: <% int(ctx().result_value) < 0 %>
      #  do:
      #    - nothing

  finish:
    action: core.echo message="all done!"
  proceed:
    action: core.echo message="Need to remediate"
  nothing:
    action: core.echo message="nothing to see here"
